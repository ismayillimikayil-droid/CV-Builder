<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - CV Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .input-group {
            position: relative;
        }

        .input-group input,
        .input-group select {
            transition: all 0.2s;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        /* Custom Scrollbar for the right panel */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }

        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms ease-out, transform 200ms ease-out;
        }

        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }

        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 200ms ease-in, transform 200ms ease-in;
        }
    </style>
</head>

<body class="bg-white min-h-screen flex flex-col md:flex-row relative">

    <!-- LEFT: Order Summary -->
    <div
        class="w-full md:w-1/2 bg-[#f9fafb] p-8 md:p-12 lg:p-20 border-r border-gray-200 order-1 md:order-1 flex flex-col">
        <!-- Back Link -->
        <a href="dashboard.html"
            class="inline-flex items-center text-gray-500 hover:text-gray-900 transition-colors mb-12 text-sm font-medium">
            <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Dashboard
        </a>

        <!-- Logo/Brand -->
        <div class="flex items-center gap-2 mb-8">
            <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white font-bold">CV</div>
            <span class="text-xl font-bold tracking-tight text-gray-900">CV Optimizer</span>
        </div>

        <div class="mb-4 text-gray-500 font-medium">Subscribe to <span id="display-plan-name">Pro</span></div>

        <!-- Big Price -->
        <div class="flex items-baseline gap-2 mb-8">
            <span class="text-5xl font-bold text-gray-900 tracking-tight" id="display-big-price">...</span>
            <span class="text-gray-500" id="display-billing-period">/ month</span>
        </div>

        <!-- Line Items -->
        <div class="flex-1">
            <div class="flex justify-between items-center py-4 border-t border-gray-200">
                <span class="text-gray-700 font-medium" id="display-item-name">Pro Plan</span>
                <span class="text-gray-900 font-medium" id="display-item-price">...</span>
            </div>

            <div class="flex justify-between items-center py-4 border-t border-gray-200">
                <span class="text-gray-700">Subtotal</span>
                <span class="text-gray-900 font-medium" id="display-subtotal">...</span>
            </div>

            <!-- Promo Code -->
            <div class="py-4 border-t border-gray-200">
                <button class="text-blue-600 text-sm font-medium hover:text-blue-700 flex items-center gap-1">
                    <i data-lucide="tag" class="w-4 h-4"></i> Add promotion code
                </button>
            </div>

            <div class="flex justify-between items-center py-6 border-t border-gray-200 mt-auto">
                <span class="text-gray-900 font-bold">Total due today</span>
                <span class="text-gray-900 font-bold text-xl" id="display-total">...</span>
            </div>
        </div>

        <div class="mt-8 text-xs text-gray-400 flex gap-4">
            <a href="#" onclick="alert('Terms of Service: This is a demo application.')"
                class="hover:underline">Terms</a>
            <a href="#" onclick="alert('Privacy Policy: No data is actually processed.')"
                class="hover:underline">Privacy</a>
            <span class="flex items-center gap-1 ml-auto"><i data-lucide="lock" class="w-3 h-3"></i> Secure
                Checkout</span>
        </div>
    </div>

    <!-- RIGHT: Payment Form -->
    <div class="w-full md:w-1/2 bg-white p-8 md:p-12 lg:p-20 order-2 md:order-2 overflow-y-auto custom-scrollbar">



        <form onsubmit="handlePayment(event)" class="space-y-6">

            <!-- Email -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Email address</label>
                <input type="email" id="customer-email"
                    class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                    placeholder="you@example.com" required>
            </div>

            <!-- Card Details -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Card information</label>
                <div class="border border-gray-300 rounded-lg overflow-hidden shadow-sm">
                    <div class="flex items-center border-b border-gray-300 px-3 py-3 bg-white">
                        <i data-lucide="credit-card" class="w-5 h-5 text-gray-400 mr-3"></i>
                        <input type="text" class="w-full outline-none text-gray-900 placeholder-gray-400"
                            placeholder="1234 1234 1234 1234" required>
                        <div class="flex gap-1 ml-2">
                            <!-- Card Icons -->
                            <img src="https://img.icons8.com/color/48/visa.png" class="h-5 w-auto grayscale opacity-50">
                            <img src="https://img.icons8.com/color/48/mastercard.png"
                                class="h-5 w-auto grayscale opacity-50">
                        </div>
                    </div>
                    <div class="flex divide-x divide-gray-300 bg-white">
                        <input type="text" class="w-1/2 px-4 py-3 outline-none text-gray-900 placeholder-gray-400"
                            placeholder="MM / YY" required>
                        <input type="text" class="w-1/2 px-4 py-3 outline-none text-gray-900 placeholder-gray-400"
                            placeholder="CVC" required>
                    </div>
                </div>
            </div>

            <!-- Google Pay Option -->
            <div>
                <label
                    class="relative flex items-center p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors">
                    <input type="radio" name="payment-method"
                        class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                    <span class="ml-3 flex items-center gap-2 font-medium text-gray-700">
                        <img src="https://img.icons8.com/color/48/google-pay.png" class="h-5 w-auto" alt="Google Pay">
                        Google Pay
                    </span>
                </label>
            </div>

            <!-- Cardholder Name -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Name on card</label>
                <input type="text"
                    class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                    placeholder="Full Name" required>
            </div>

            <!-- Country -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Country or region</label>
                <select id="country-select"
                    class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-white cursor-pointer"
                    onchange="updateCurrencyFromSelection()">
                    <!-- Populated by JS -->
                </select>
            </div>

            <button type="submit" id="pay-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg shadow-blue-500/20 transition-all mt-8 transform active:scale-[0.99]">
                Subscribe
            </button>

            <p class="text-center text-xs text-gray-400 mt-4 leading-relaxed">
                By confirming your subscription, you allow CV Optimizer to charge your card for this payment and future
                payments in accordance with our terms.
            </p>
        </form>
    </div>

    <!-- LINK POPUP MODAL -->
    <div id="link-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-200">
        <div class="bg-white rounded-2xl w-full max-w-[440px] shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200 relative mx-4"
            onclick="event.stopPropagation()">

            <!-- Close Button -->
            <button onclick="closeLinkModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <!-- Header -->
            <div class="text-center pt-8 pb-4">
                <div class="inline-flex items-center justify-center gap-1 mb-4 text-[#00D639]">
                    <span class="font-bold text-lg leading-none">></span>
                    <span class="font-bold text-2xl tracking-tighter leading-none italic">link</span>
                </div>
                <h2 class="text-xl font-bold text-gray-900 mb-1">Fast and secure checkout</h2>
                <p class="text-sm text-gray-500">Pay faster everywhere Link is accepted.</p>
            </div>

            <!-- Body -->
            <div class="p-6 pt-2">
                <label class="block text-xs font-bold text-gray-700 uppercase mb-1 ml-1">Email</label>
                <input type="email" id="link-email-input" value="ismayillimikayil@gmail.com"
                    class="w-full border border-gray-300 rounded-xl px-4 py-4 text-lg focus:outline-none focus:ring-2 focus:ring-[#00D639] focus:border-transparent mb-6 shadow-sm"
                    placeholder="Email address">

                <button onclick="processLinkPay()" id="link-pay-btn"
                    class="w-full bg-[#00D639] hover:bg-[#00c233] text-white font-bold py-4 rounded-xl text-lg transition-colors shadow-md transform active:scale-[0.99] flex items-center justify-center gap-2">
                    Pay <span id="link-pay-amount">...</span>
                </button>
            </div>

            <!-- Footer -->
            <div
                class="bg-gray-50 p-4 text-center border-t border-gray-100 flex justify-center gap-4 text-xs text-gray-400 font-medium">
                <a href="#" class="hover:text-gray-600">Terms</a>
                <a href="#" class="hover:text-gray-600">Privacy</a>
                <a href="#" class="hover:text-gray-600">Cookie settings</a>
            </div>
        </div>
    </div>

    <!-- Paddle.js -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
    <script>
        lucide.createIcons();

        // Initialize Paddle (Replace 'test_...' with your actual Client Token)
        // You can find this in Paddle Dashboard > Developer Tools > Authentication
        Paddle.Environment.set('production'); // Explicitly set for live tokens
        Paddle.Initialize({
            token: 'live_f303461a6730f427737333f2feb' // TODO: REPLACE THIS WITH USER'S CLIENT TOKEN
        });

        // --- Configuration ---
        const PLANS = {
            monthly: {
                name: 'Pro Monthly',
                priceUSD: 12.00,
                billing: '/ month',
                priceId: 'pri_01khbedtb367hwq2my92tqpv7w' // Monthly Paddle ID
            },
            annual: {
                name: 'Pro Annual',
                priceUSD: 99.00,
                billing: '/ year',
                priceId: 'pri_01khbefy3c92k9x9tk7tm4ae16' // Yearly Paddle ID
            }
        };

        const RATES = {
            'US': { currency: 'USD', rate: 1, symbol: '$' },
            'AZ': { currency: 'AZN', rate: 1.7, symbol: '₼' },
            'TR': { currency: 'TRY', rate: 30.5, symbol: '₺' },
            'GB': { currency: 'GBP', rate: 0.79, symbol: '£' },
            'EU': { currency: 'EUR', rate: 0.92, symbol: '€' },
            'DE': { currency: 'EUR', rate: 0.92, symbol: '€' },
            'RU': { currency: 'RUB', rate: 91.5, symbol: '₽' },
            'IN': { currency: 'INR', rate: 83.0, symbol: '₹' },
            'CA': { currency: 'CAD', rate: 1.35, symbol: 'C$' },
            'AU': { currency: 'AUD', rate: 1.52, symbol: 'A$' },
        };

        const ALL_COUNTRIES = [
            { code: 'US', name: 'United States' },
            { code: 'AZ', name: 'Azerbaijan' },
            { code: 'TR', name: 'Turkey' },
            { code: 'GB', name: 'United Kingdom' },
            { code: 'DE', name: 'Germany' },
            { code: 'RU', name: 'Russia' },
            { code: 'IN', name: 'India' },
            { code: 'CA', name: 'Canada' },
            { code: 'AU', name: 'Australia' },
            { code: 'FR', name: 'France' },
            { code: 'ES', name: 'Spain' },
            { code: 'IT', name: 'Italy' },
            { code: 'BR', name: 'Brazil' },
            { code: 'AE', name: 'United Arab Emirates' },
        ];

        // --- State ---
        const params = new URLSearchParams(window.location.search);
        const planKey = params.get('plan') || 'monthly';
        const selectedPlan = PLANS[planKey] || PLANS.monthly;
        let currentCountry = 'US';
        let currentPriceString = ''; // Store for Link modal

        // --- Initialization ---
        async function init() {
            // 1. Populate Country Select
            const select = document.getElementById('country-select');
            ALL_COUNTRIES.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.code;
                opt.innerText = c.name;
                select.appendChild(opt);
            });

            // 2. Detect Country (IP-based)
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();

                if (data.country_code && ALL_COUNTRIES.find(c => c.code === data.country_code)) {
                    currentCountry = data.country_code;
                } else if (ALL_COUNTRIES.find(c => c.code === data.country_code)) {
                    currentCountry = data.country_code;
                }
            } catch (e) {
                console.warn('Geo-detection failed');
            }

            // 3. Set UI
            select.value = currentCountry;
            updateUI();
        }

        // --- Logic ---
        function updateUI() {
            let rateData = RATES[currentCountry];

            if (!rateData) {
                if (['FR', 'ES', 'IT', 'DE'].includes(currentCountry)) {
                    rateData = RATES['EU'];
                } else {
                    rateData = RATES['US'];
                }
            }

            const price = (selectedPlan.priceUSD * rateData.rate).toFixed(2);
            let priceString = `${price} ${rateData.currency}`;

            if (rateData.currency === 'USD') priceString = `$${price}`;
            else if (rateData.currency === 'EUR') priceString = `€${price}`;
            else if (rateData.currency === 'AZN') priceString = `${price} AZN`;

            currentPriceString = priceString; // Save for modal

            document.getElementById('display-plan-name').innerText = selectedPlan.name;
            document.getElementById('display-item-name').innerText = selectedPlan.name;
            document.getElementById('display-billing-period').innerText = selectedPlan.billing;

            document.getElementById('display-big-price').innerText = priceString;
            document.getElementById('display-item-price').innerText = priceString;
            document.getElementById('display-subtotal').innerText = priceString;
            document.getElementById('display-total').innerText = priceString;
            document.getElementById('link-pay-amount').innerText = priceString; // Update Link modal

            document.getElementById('customer-email').value = localStorage.getItem('userEmail') || '';
        }

        function updateCurrencyFromSelection() {
            currentCountry = document.getElementById('country-select').value;
            updateUI();
        }

        // --- Link Modal Logic ---
        function handleLinkPayment(btn) {
            updateUI(); // Ensure price is current
            const modal = document.getElementById('link-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { // Small delay for animation
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeLinkModal() {
            const modal = document.getElementById('link-modal');
            modal.querySelector('div').classList.add('scale-95');
            modal.querySelector('div').classList.remove('scale-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // Close on backdrop click
        document.getElementById('link-modal').addEventListener('click', closeLinkModal);

        function processLinkPay() {
            // Reuse Handle Payment logic
            handlePayment(new Event('submit'));
        }

        function handlePayment(e) {
            e.preventDefault();
            const btn = document.getElementById('pay-btn');

            // Get selected plan ID
            // Use planKey from outer scope
            const priceId = (planKey === 'monthly') ? PLANS.monthly.priceId : PLANS.annual.priceId;

            const email = document.getElementById('customer-email').value;

            btn.innerText = 'Opening Secure Checkout...';
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-wait');

            // Open Paddle Checkout with Error Handling
            try {
                Paddle.Checkout.open({
                    items: [{ priceId: priceId, quantity: 1 }],
                    customer: { email: email },
                    settings: {
                        successUrl: window.location.origin + '/dashboard.html?upgrade=success',
                        displayMode: 'overlay',
                        theme: 'light',
                        locale: 'en'
                    },
                    closed: () => {
                        console.log('Paddle checkout closed');
                        btn.innerText = 'Subscribe';
                        btn.disabled = false;
                        btn.classList.remove('opacity-75', 'cursor-wait');
                    }
                });
            } catch (err) {
                console.error('Paddle Error:', err);
                alert('Paddle initialization failed. Please check the console for details. Common cause: Domain approval.');
                btn.innerText = 'Error - Try Again';
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-wait');
            }
        }

        init();
    </script>
</body>

</html>